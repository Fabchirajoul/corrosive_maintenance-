<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Anti-Corrosion Maintenance — AI Suite</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<style>
  body{background:#f6f8f7}
  .sidebar{position:fixed;inset:0 auto 0 0;width:280px;background:#1f6b5a;color:#fff;padding:1rem;overflow-y:auto}
  .sidebar a{display:block;color:#e6fff6;text-decoration:none;padding:.55rem .7rem;border-radius:.5rem}
  .sidebar a.active,.sidebar a:hover{background:rgba(255,255,255,.14)}
  .main{margin-left:280px;padding:1.2rem}
  .module{display:none}
  .section-card{border-radius:.75rem}
  .note{font-size:.92rem;color:#5b6a66}
  .checkgrid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:.35rem .75rem}
  @media(max-width:991px){.checkgrid{grid-template-columns:repeat(2,minmax(0,1fr))}}
  .kpi{border-left:6px solid #cfe9e2}
  .kpi .val{font-weight:700;font-size:1.5rem}
  .muted{color:#6b7b76}

  /* CV canvas */
  .canvas-wrap{position:relative;display:inline-block;max-width:100%}
  #cvCanvas{max-width:100%;height:auto;border-radius:.5rem;border:1px solid #e5e7eb;background:#fff}
  .legend-badge{display:inline-block;width:12px;height:12px;border-radius:2px;margin-right:6px;vertical-align:middle}
</style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar">
  <div class="d-flex align-items-center mb-3">
    <div class="rounded-circle bg-light me-2" style="width:44px;height:44px"></div>
    <div><div class="fw-bold">Founder Dashboard</div><small>Anti-Corrosion AI</small></div>
  </div>
  <div class="text-uppercase small mb-2 opacity-75">Modules</div>
  <nav id="nav">
    <a href="#predict" data-open="predict" class="active">3.4.1 Predictive Analytics</a>
    <a href="#autocv"  data-open="autocv">3.4.2 Automated Detection (CV)</a>
    <a href="#twin"    data-open="twin">3.4.3 Digital Twin</a>
    <a href="#remote"  data-open="remote">3.4.5 Remote Monitoring</a>
    <a href="#risk"    data-open="risk">3.4.4 Smart Risk Prioritization</a>
    <a href="#know"    data-open="know">3.4.6 Knowledge Integration</a>
    <div class="text-uppercase small mt-3 mb-2 opacity-75">Added best-practice</div>
    <a href="#cp"      data-open="cp">Cathodic Protection (CP)</a>
    <a href="#rbi"     data-open="rbi">RBI Planner & Coatings</a>
  </nav>
</aside>

<!-- Main -->
<main class="main">
  <h2 class="fw-bold mb-3">ANTI-CORROSION MAINTENANCE — AI SUITE</h2>

  <!-- KPIs -->
  <div class="row g-3 mb-3">
    <div class="col-md-3"><div class="card kpi"><div class="card-body">
      <div class="muted">Live Sensors Online</div><div class="val" id="kpiSensors">14</div><div class="text-success small">+2 today</div>
    </div></div></div>
    <div class="col-md-3"><div class="card kpi"><div class="card-body">
      <div class="muted">High-Risk Assets</div><div class="val" id="kpiHigh">3</div><div class="text-danger small">needs action</div>
    </div></div></div>
    <div class="col-md-3"><div class="card kpi"><div class="card-body">
      <div class="muted">Avg Corrosion Rate</div><div class="val" id="kpiCr">2.8 <span class="small">mm/yr</span></div><div class="text-success small">down 0.2</div>
    </div></div></div>
    <div class="col-md-3"><div class="card kpi"><div class="card-body">
      <div class="muted">Open CAPAs</div><div class="val" id="kpiCapa">7</div><div class="small">3 due &lt; 7d</div>
    </div></div></div>
  </div>

  <!-- 3.4.1 Predictive Analytics -->
  <section id="predict" class="module" style="display:block;">
    <div class="card section-card mb-3">
      <div class="card-header bg-success text-white"><i class="bi bi-graph-up-arrow me-1"></i> Predictive Analytics — Forecasting Degradation</div>
      <div class="card-body">
        <div class="note mb-2">Inputs: UT thickness (mm), moisture (%), temperature (°C), inspector notes. Output: a line chart with actual vs AI forecast and the expected degradation curve — supports proactive maintenance planning.</div>
        <form id="formPredict" class="row g-2">
          <div class="col-md-3"><label class="form-label">Asset</label><input class="form-control" name="asset" placeholder="Pipeline A12"></div>
          <div class="col-md-3"><label class="form-label">Avg UT Thickness (mm)</label><input type="number" step="0.01" class="form-control" name="ut" value="7.8"></div>
          <div class="col-md-3"><label class="form-label">Moisture (%)</label><input type="number" step="0.1" class="form-control" name="moist" value="68"></div>
          <div class="col-md-3"><label class="form-label">Temp (°C)</label><input type="number" step="0.1" class="form-control" name="temp" value="35"></div>
          <div class="col-md-12"><label class="form-label">Notes</label><input class="form-control" name="notes" placeholder="Under insulation; salt spray"></div>
          <div class="col-md-3 d-grid"><label class="form-label invisible">.</label><button class="btn btn-success" type="submit">Run Forecast</button></div>
        </form>
        <hr>
        <div class="row g-3">
          <div class="col-lg-8"><div class="border rounded p-3"><div class="fw-bold">Corrosion Rate — Actual vs Forecast (mm/yr)</div><canvas id="chartPredict" height="140"></canvas></div></div>
          <div class="col-lg-4"><div class="border rounded p-3"><div class="fw-bold">Result (What this means)</div>
            <div id="predictText" class="note">AI projects mild acceleration in Aug–Oct. Advance coating touch-up before month-end to avoid high loss.</div>
          </div></div>
        </div>
      </div>
    </div>

    <div class="card section-card mb-3">
      <div class="card-header">Historical Forecasts</div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0 align-middle">
          <thead class="table-light"><tr><th>Date</th><th>Asset</th><th>Avg UT</th><th>Moisture</th><th>Result</th><th>Action</th></tr></thead>
          <tbody id="tblPredict"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 3.4.2 Automated Detection (CV) — REBUILT -->
  <section id="autocv" class="module">
    <div class="card section-card mb-3">
      <div class="card-header bg-success text-white"><i class="bi bi-bounding-box me-1"></i> Automated Detection — Images / Video (AI CV)</div>
      <div class="card-body">
        <div class="note mb-2">Inputs: Drone/handheld images, thermal/IR frames. Output: <strong>annotated image</strong> with labeled boxes (rust, delamination, cracks, pitting, CUI), a detections table, and counts by class.</div>

        <form id="formCV" class="row g-2">
          <div class="col-lg-6">
            <label class="form-label">Inspection Media</label>
            <input id="cvMedia" type="file" class="form-control" accept="image/*,video/*">
            <div class="form-text">.jpg/.png/.webp or .mp4/.webm (first frame annotated).</div>
          </div>
          <div class="col-lg-6">
            <label class="form-label">Target Defects</label>
            <div class="checkgrid">
              <label><input class="cv-cls" type="checkbox" value="Rust" checked> Rust</label>
              <label><input class="cv-cls" type="checkbox" value="Coating Failure" checked> Coating Failure</label>
              <label><input class="cv-cls" type="checkbox" value="Delamination"> Delamination</label>
              <label><input class="cv-cls" type="checkbox" value="Crack"> Crack</label>
              <label><input class="cv-cls" type="checkbox" value="Pitting"> Pitting</label>
              <label><input class="cv-cls" type="checkbox" value="Corrosion Under Insulation"> CUI</label>
            </div>
          </div>
          <div class="col-lg-3">
            <label class="form-label">Confidence Threshold (%)</label>
            <input id="cvThresh" type="number" class="form-control" value="55" min="1" max="99">
          </div>
          <div class="col-lg-3">
            <label class="form-label">Max Detections</label>
            <input id="cvMax" type="number" class="form-control" value="12" min="1" max="50">
          </div>
          <div class="col-lg-3 d-grid">
            <label class="form-label invisible">.</label>
            <button class="btn btn-success" type="submit"><i class="bi bi-cpu me-1"></i> Run Detection</button>
          </div>
          <div class="col-lg-3 d-grid">
            <label class="form-label invisible">.</label>
            <button id="cvSave" class="btn btn-outline-primary" type="button" disabled><i class="bi bi-save me-1"></i> Save to History</button>
          </div>
        </form>

        <hr>

        <div class="row g-3">
          <div class="col-xl-7">
            <div class="border rounded p-3">
              <div class="fw-bold">Annotated Output</div>
              <div class="canvas-wrap"><canvas id="cvCanvas" width="640" height="400"></canvas></div>
              <div id="cvLegend" class="small mt-2"></div>
              <div id="cvNote" class="note mt-1">Upload media, pick classes, then Run Detection. All detected defects will be drawn on the image.</div>
            </div>
          </div>
          <div class="col-xl-5">
            <div class="border rounded p-3 h-100">
              <div class="fw-bold">Detection Summary</div>
              <canvas id="cvCounts" height="140"></canvas>
              <div class="table-responsive mt-3">
                <table class="table table-sm align-middle mb-0">
                  <thead class="table-light">
                    <tr><th>#</th><th>Class</th><th>Conf.</th><th>Box (x,y,w,h)</th></tr>
                  </thead>
                  <tbody id="cvTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="card section-card mb-3">
      <div class="card-header">Historical Detections</div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0 align-middle">
          <thead class="table-light"><tr><th>Date</th><th>Media</th><th>Summary</th><th>Action</th></tr></thead>
          <tbody id="tblCV">
            <tr>
              <td>2025-09-18</td><td>shaft_beam_3.jpg</td><td>Rust: 5, Coating Failure: 2</td>
              <td><button class="btn btn-sm btn-outline-primary" data-detail="%7B%22mode%22%3A%22image%22%2C%22img%22%3A%22%22%7D">View</button></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 3.4.3 Digital Twin -->
  <section id="twin" class="module">
    <div class="card section-card mb-3">
      <div class="card-header bg-success text-white"><i class="bi bi-diagram-3 me-1"></i> Digital Twin — Corrosion Hotspots</div>
      <div class="card-body">
        <div class="note mb-2">Inputs: Laser/CAD grid points + inspection & sensor tags. Output: interactive hotspot scatter (color ≈ intensity).</div>
        <form id="formTwin" class="row g-2">
          <div class="col-md-4"><label class="form-label">Asset</label><input class="form-control" name="asset" placeholder="Tank B07"></div>
          <div class="col-md-4"><label class="form-label">Points (n)</label><input type="number" class="form-control" name="pts" value="30"></div>
          <div class="col-md-4 d-grid"><label class="form-label invisible">.</label><button class="btn btn-success" type="submit">Generate</button></div>
        </form>
        <hr>
        <div class="border rounded p-3"><div class="fw-bold">Hotspot Map</div><canvas id="twinScatter" height="180"></canvas></div>
      </div>
    </div>

    <div class="card section-card mb-3">
      <div class="card-header">Historical Twins</div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0 align-middle">
          <thead class="table-light"><tr><th>Date</th><th>Asset</th><th>Points</th><th>Notes</th><th>Action</th></tr></thead>
          <tbody id="tblTwin"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 3.4.5 Remote Monitoring -->
  <section id="remote" class="module">
    <div class="card section-card mb-3">
      <div class="card-header bg-success text-white"><i class="bi bi-rss me-1"></i> Remote Monitoring — Live Sensors</div>
      <div class="card-body">
        <div class="note mb-2">Inputs: IoT feeds (corrosion probes, humidity, temp). Output: live bar chart, threshold alerts (conceptual).</div>
        <form id="formRemote" class="row g-2">
          <div class="col-md-4"><label class="form-label">Station</label><input class="form-control" name="station" value="PERIM-NE-02"></div>
          <div class="col-md-4"><label class="form-label">Update Every (sec)</label><input type="number" class="form-control" name="freq" value="5"></div>
          <div class="col-md-4 d-grid"><label class="form-label invisible">.</label><button class="btn btn-success" type="submit">Start</button></div>
        </form>
        <hr>
        <div class="border rounded p-3"><div class="fw-bold">Live Readings</div><canvas id="remoteBar" height="150"></canvas></div>
      </div>
    </div>

    <div class="card section-card mb-3">
      <div class="card-header">Recent Streams</div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0 align-middle">
          <thead class="table-light"><tr><th>Time</th><th>Station</th><th>Sensors</th><th>Max (%)</th><th>Action</th></tr></thead>
          <tbody id="tblRemote"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 3.4.4 Smart Risk Prioritization -->
  <section id="risk" class="module">
    <div class="card section-card mb-3">
      <div class="card-header bg-success text-white"><i class="bi bi-exclamation-triangle me-1"></i> Smart Risk Prioritization — RBI-style Ranking</div>
      <div class="card-body">
        <div class="note mb-2">Inputs: Age, exposure (humidity/salinity), inspection history, operating environment. Output: horizontal bar ranking (green/amber/red) to focus limited resources.</div>
        <form id="formRisk" class="row g-2">
          <div class="col-md-4"><label class="form-label">Asset Name</label><input class="form-control" name="name" placeholder="Pipeline A12"></div>
          <div class="col-md-4"><label class="form-label">Asset Age (yrs)</label><input type="number" class="form-control" name="age" value="12"></div>
          <div class="col-md-4"><label class="form-label">Environment</label>
            <select class="form-select" name="env"><option>C3 (Urban/Industrial)</option><option selected>C4 (Marine/Offshore)</option><option>C5/CX (Extreme)</option></select>
          </div>
          <div class="col-md-12"><label class="form-label">Risk Drivers</label>
            <div class="checkgrid">
              <label><input type="checkbox" checked> High salinity</label>
              <label><input type="checkbox" checked> High humidity</label>
              <label><input type="checkbox"> Under-insulation (CUI)</label>
              <label><input type="checkbox"> Poor coating</label>
              <label><input type="checkbox"> CP shielding</label>
              <label><input type="checkbox"> Past leaks</label>
            </div>
          </div>
          <div class="col-md-3 d-grid"><label class="form-label invisible">.</label><button class="btn btn-success" type="submit">Score</button></div>
        </form>
        <hr>
        <div class="border rounded p-3"><div class="fw-bold">Asset Ranking by Risk (%)</div><canvas id="riskBar" height="160"></canvas></div>
      </div>
    </div>

    <div class="card section-card mb-3">
      <div class="card-header">Risk Runs</div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0 align-middle">
          <thead class="table-light"><tr><th>Date</th><th>Top Asset</th><th>Risk</th><th>Priority</th><th>Action</th></tr></thead>
          <tbody id="tblRisk"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 3.4.6 Knowledge Integration -->
  <section id="know" class="module">
    <div class="card section-card mb-3">
      <div class="card-header bg-success text-white"><i class="bi bi-archive me-1"></i> Knowledge Integration — Cases Library</div>
      <div class="card-body">
        <div class="note mb-2">Inputs: past inspection logs, maintenance records, sensor archives. Output: searchable case list to compare with current issues and avoid repeat mistakes.</div>
        <form id="formKnow" class="row g-2">
          <div class="col-md-8"><label class="form-label">Upload/Enter inspection logs</label><textarea class="form-control" rows="2" name="log"></textarea></div>
          <div class="col-md-4 d-grid"><label class="form-label invisible">.</label><button class="btn btn-success" type="submit">Integrate</button></div>
        </form>
        <hr>
        <div class="border rounded p-3">
          <div class="fw-bold">Cases</div>
          <table class="table table-sm align-middle mb-0"><thead class="table-light"><tr><th>Case</th><th>Risk</th><th>Action</th><th></th></tr></thead><tbody id="tblKnow"></tbody></table>
        </div>
      </div>
    </div>
  </section>

  <!-- Added: Cathodic Protection -->
  <section id="cp" class="module">
    <div class="card section-card mb-3">
      <div class="card-header bg-success text-white"><i class="bi bi-battery-charging me-1"></i> Cathodic Protection — Potentials</div>
      <div class="card-body">
        <div class="note mb-2">Inputs: Pipe-to-soil potentials (mV vs Cu/CuSO₄), current, anode status. Output: trend vs protection window (e.g., ≤ −850 mV criterion), highlighting under/over-protection.</div>
        <form id="formCP" class="row g-2">
          <div class="col-md-4"><label class="form-label">Line</label><input class="form-control" name="line" value="Trunk 14"></div>
          <div class="col-md-4"><label class="form-label">Reading (mV)</label><input type="number" class="form-control" name="mV" value="-830"></div>
          <div class="col-md-4 d-grid"><label class="form-label invisible">.</label><button class="btn btn-success" type="submit">Log Reading</button></div>
        </form>
        <hr>
        <div class="border rounded p-3"><div class="fw-bold">CP Trend (mV)</div><canvas id="cpLine" height="150"></canvas></div>
      </div>
    </div>
  </section>

  <!-- Added: RBI Planner & Coatings -->
  <section id="rbi" class="module">
    <div class="card section-card mb-3">
      <div class="card-header bg-success text-white"><i class="bi bi-journal-check me-1"></i> RBI Planner & Coating Systems</div>
      <div class="card-body">
        <div class="note mb-2">Inputs: corrosion category (ISO-12944 C1–CX), durability, last inspection. Output: inspection interval & suggested coating system.</div>
        <form id="formRBI" class="row g-2">
          <div class="col-md-4"><label class="form-label">Corrosivity</label>
            <select class="form-select" name="cat"><option>C3</option><option selected>C4</option><option>C5/CX</option></select>
          </div>
          <div class="col-md-4"><label class="form-label">Durability</label>
            <select class="form-select" name="dur"><option>Medium</option><option selected>High</option><option>Very High</option></select>
          </div>
          <div class="col-md-4"><label class="form-label">Last Inspection (months)</label><input type="number" class="form-control" name="last" value="16"></div>
          <div class="col-md-3 d-grid"><label class="form-label invisible">.</label><button class="btn btn-success" type="submit">Plan</button></div>
        </form>
        <hr>
        <div class="row g-3">
          <div class="col-lg-6"><div class="border rounded p-3"><div class="fw-bold">Next Inspection Plan</div><div id="rbiPlan" class="note">—</div></div></div>
          <div class="col-lg-6"><div class="border rounded p-3"><div class="fw-bold">Coating Suggestion</div><div id="coatSuggest" class="note">—</div></div></div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Modal (charts OR annotated image) -->
<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="detailTitle">Details</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div id="detailText" class="note mb-2"></div>
        <img id="detailImg" class="img-fluid rounded border mb-2" alt="Annotated result" style="display:none">
        <canvas id="detailCanvas" height="200"></canvas>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
/* ---------- helpers / nav ---------- */
function openModule(id){
  var mods = document.querySelectorAll(".module");
  for (var i=0;i<mods.length;i++){ mods[i].style.display="none"; }
  var el = document.getElementById(id);
  if(el){ el.style.display="block"; window.scrollTo({top:0,behavior:"smooth"}); }
}
document.getElementById("nav").addEventListener("click",function(e){
  var t=e.target;
  if(t && t.dataset.open){
    e.preventDefault();
    var links=this.querySelectorAll("a");
    for(var i=0;i<links.length;i++){ links[i].classList.remove("active"); }
    t.classList.add("active");
    openModule(t.dataset.open);
  }
});

function addRow(tbodyId, cells, detail){
  var tb=document.getElementById(tbodyId);
  var tr=document.createElement("tr");

  for(var i=0;i<cells.length;i++){
    var td=document.createElement("td");
    td.textContent=cells[i];
    tr.appendChild(td);
  }

  var btnCell=document.createElement("td");
  var btn=document.createElement("button");
  btn.className="btn btn-sm btn-outline-primary";
  btn.textContent="View";
  try{
    btn.dataset.detail = encodeURIComponent(JSON.stringify(detail||{}));
  }catch(err){
    btn.dataset.detail = encodeURIComponent("{}");
  }
  btnCell.appendChild(btn);
  tr.appendChild(btnCell);

  if(tb.firstChild){ tb.insertBefore(tr, tb.firstChild); } else { tb.appendChild(tr); }
}

function gradeColor(v){
  if(v>=70){return "#d9534f";}
  if(v>=40){return "#f0ad4e";}
  return "#5cb85c";
}

/* ---------- modal (chart or image) ---------- */
var detailChart=null;
function openChartDetail(title, text, cfg){
  var ttl=document.getElementById("detailTitle");
  var txt=document.getElementById("detailText");
  var img=document.getElementById("detailImg");
  var canv=document.getElementById("detailCanvas");

  ttl.textContent=title||"Details";
  txt.textContent=text||"";

  img.style.display="none";
  canv.style.display="block";

  var ctx=canv.getContext("2d");
  if(detailChart){ detailChart.destroy(); }
  detailChart=new Chart(ctx, cfg);

  new bootstrap.Modal(document.getElementById("detailModal")).show();
}
function openImageDetail(title, text, dataUrl){
  var ttl=document.getElementById("detailTitle");
  var txt=document.getElementById("detailText");
  var img=document.getElementById("detailImg");
  var canv=document.getElementById("detailCanvas");

  ttl.textContent=title||"Details";
  txt.textContent=text||"";
  img.src=dataUrl||"";
  img.style.display="block";
  canv.style.display="none";

  new bootstrap.Modal(document.getElementById("detailModal")).show();
}

/* ---------- 3.4.1 Predictive ---------- */
var chartPredict=new Chart(
  document.getElementById("chartPredict").getContext("2d"),
  {
    type:"line",
    data:{
      labels:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct"],
      datasets:[
        {label:"Actual",   data:[0.8,1.1,1.6,2.2,2.8,3.1,3.3,3.4,3.6,3.8], tension:0.3},
        {label:"Forecast", data:[0.9,1.2,1.7,2.3,2.9,3.2,3.5,3.9,4.2,4.5], borderDash:[6,4], tension:0.3}
      ]
    },
    options:{plugins:{legend:{position:"bottom"}},responsive:true}
  }
);
addRow(
  "tblPredict",
  ["2025-09-20","Pipeline A12","7.8","68%","Forecast rise Aug–Oct"],
  {mode:"line",labels:["Jul","Aug","Sep","Oct"],before:[3.3,3.4,3.6,3.8],after:[3.5,3.9,4.2,4.5]}
);
document.getElementById("formPredict").addEventListener("submit",function(e){
  e.preventDefault();
  var fd=new FormData(e.target);
  var moist=parseFloat(fd.get("moist")||"60");
  var adj=(moist-40)/40; if(adj<0.4){adj=0.4;} if(adj>1.8){adj=1.8;}

  var base=[0.9,1.2,1.7,2.3,2.9,3.2,3.5,3.9,4.2,4.5];
  base[7]=3.9+adj*0.2; base[8]=4.2+adj*0.3; base[9]=4.5+adj*0.3;

  chartPredict.data.datasets[1].data=base;
  chartPredict.update();

  document.getElementById("predictText").textContent=
    "AI forecast adjusted for moisture. Expected "+base[9].toFixed(1)+" mm/yr by Oct. Plan coating before 4.0.";

  addRow(
    "tblPredict",
    [new Date().toISOString().slice(0,10), fd.get("asset")||"Asset", (parseFloat(fd.get("ut")||"7.8")).toFixed(2), (moist||0)+"%", "Updated forecast"],
    {mode:"line",labels:["Jul","Aug","Sep","Oct"],before:[3.3,3.4,3.6,3.8],after:[base[6],base[7],base[8],base[9]]}
  );
});

/* ---------- 3.4.2 Automated Detection (CV) ---------- */
var cvCanvas=document.getElementById("cvCanvas");
var cvCtx=cvCanvas.getContext("2d");
var cvImage=null;
var cvCountsChart=null;
var cvAnnotatedURL="";

var CLASS_COLORS={
  "Rust":"#e74c3c",
  "Coating Failure":"#f39c12",
  "Delamination":"#8e44ad",
  "Crack":"#2c3e50",
  "Pitting":"#16a085",
  "Corrosion Under Insulation":"#2980b9"
};
function cvPlaceholder(){
  cvCtx.fillStyle="#fff"; cvCtx.fillRect(0,0,cvCanvas.width,cvCanvas.height);
  cvCtx.strokeStyle="#e5e7eb"; cvCtx.strokeRect(0,0,cvCanvas.width,cvCanvas.height);
  cvCtx.fillStyle="#94a3b8"; cvCtx.font="14px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  cvCtx.fillText("No media loaded. Upload then Run Detection.", 16, 28);
}
cvPlaceholder();

function renderLegendCV(list){
  var el=document.getElementById("cvLegend");
  var html="";
  for(var i=0;i<list.length;i++){
    var c=list[i];
    var col=CLASS_COLORS[c]||"#333";
    html+='<span class="legend-badge" style="background:'+col+'"></span>'+c;
    if(i<list.length-1){ html+=" &nbsp;&nbsp; "; }
  }
  if(html===""){ html='<span class="text-muted">No classes selected</span>'; }
  el.innerHTML=html;
}
function drawImageFit(img){
  var cw=cvCanvas.width, ch=cvCanvas.height;
  cvCtx.clearRect(0,0,cw,ch);
  cvCtx.fillStyle="#fff"; cvCtx.fillRect(0,0,cw,ch);
  var iw=img.naturalWidth||img.width, ih=img.naturalHeight||img.height;
  var ar=iw/ih, car=cw/ch;
  var dw=cw, dh=Math.round(cw/ar), dx=0, dy=Math.round((ch-dh)/2);
  if(ar<car){ dh=ch; dw=Math.round(ch*ar); dx=Math.round((cw-dw)/2); dy=0; }
  cvCtx.drawImage(img,dx,dy,dw,dh);
  return {dx:dx,dy:dy,dw:dw,dh:dh,scaleX:dw/iw,scaleY:dh/ih};
}
function drawBoxesCV(boxes, m){
  for(var i=0;i<boxes.length;i++){
    var b=boxes[i];
    var x=m.dx + Math.round(b.x*m.scaleX);
    var y=m.dy + Math.round(b.y*m.scaleY);
    var w=Math.round(b.w*m.scaleX);
    var h=Math.round(b.h*m.scaleY);
    cvCtx.lineWidth=2;
    cvCtx.strokeStyle=CLASS_COLORS[b.label]||"#ff0";
    cvCtx.strokeRect(x,y,w,h);
    var tag=b.label+" "+Math.round(b.score)+"%";
    cvCtx.font="12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    var tw=Math.ceil(cvCtx.measureText(tag).width)+8;
    var th=18;
    var by=Math.max(0, y-th);
    cvCtx.fillStyle="rgba(0,0,0,0.6)";
    cvCtx.fillRect(x, by, tw, th);
    cvCtx.fillStyle="#fff";
    cvCtx.fillText(tag, x+4, by+13);
  }
}
function synthCV(img, classes, maxDet, thr){
  var iw=img.naturalWidth||img.width, ih=img.naturalHeight||img.height;
  var out=[], i=0;
  for(i=0;i<classes.length;i++){
    var w=Math.max(40, Math.round((iw*0.08)+(Math.random()*iw*0.08)));
    var h=Math.max(40, Math.round((ih*0.08)+(Math.random()*ih*0.08)));
    var x=Math.round(Math.random()*(iw-w));
    var y=Math.round(Math.random()*(ih-h));
    var score=thr + Math.random()*(100-thr);
    out.push({label:classes[i], score:score, x:x, y:y, w:w, h:h});
  }
  var extra=Math.max(0, maxDet - out.length);
  for(i=0;i<extra;i++){
    var lab=classes[Math.floor(Math.random()*classes.length)];
    var w2=Math.max(30, Math.round((iw*0.06)+(Math.random()*iw*0.07)));
    var h2=Math.max(30, Math.round((ih*0.06)+(Math.random()*ih*0.07)));
    var x2=Math.round(Math.random()*(iw-w2));
    var y2=Math.round(Math.random()*(ih-h2));
    var score2=thr + Math.random()*(100-thr);
    out.push({label:lab, score:score2, x:x2, y:y2, w:w2, h:h2});
  }
  return out;
}
function fillCVTable(boxes){
  var tb=document.getElementById("cvTable");
  tb.innerHTML="";
  for(var i=0;i<boxes.length;i++){
    var b=boxes[i];
    var tr=document.createElement("tr");
    var c1=document.createElement("td"); c1.textContent=String(i+1);
    var c2=document.createElement("td"); c2.textContent=b.label;
    var c3=document.createElement("td"); c3.textContent=Math.round(b.score)+"%";
    var c4=document.createElement("td"); c4.textContent=b.x+","+b.y+","+b.w+","+b.h;
    tr.appendChild(c1); tr.appendChild(c2); tr.appendChild(c3); tr.appendChild(c4);
    tb.appendChild(tr);
  }
}
function updateCVCounts(boxes){
  var counts={}, labels=[], values=[], colors=[];
  for(var i=0;i<boxes.length;i++){
    var k=boxes[i].label; if(!counts[k]){counts[k]=0;} counts[k]+=1;
  }
  for(var key in counts){
    if(Object.prototype.hasOwnProperty.call(counts,key)){
      labels.push(key);
      values.push(counts[key]);
      colors.push(CLASS_COLORS[key]||"#333");
    }
  }
  if(cvCountsChart){ cvCountsChart.destroy(); }
  cvCountsChart=new Chart(
    document.getElementById("cvCounts").getContext("2d"),
    {
      type:"bar",
      data:{labels:labels,datasets:[{label:"Detections",data:values,backgroundColor:colors}]},
      options:{plugins:{legend:{position:"bottom"}},responsive:true,scales:{y:{beginAtZero:true}}}
    }
  );
}

/* media load */
document.getElementById("cvMedia").addEventListener("change", function(){
  var f=this.files && this.files[0] ? this.files[0] : null;
  document.getElementById("cvSave").disabled=true;
  if(!f){ cvPlaceholder(); return; }

  if(f.type.indexOf("image/")===0){
    var img=new Image();
    img.onload=function(){ cvImage=img; drawImageFit(img); document.getElementById("cvNote").textContent="Image loaded. Run Detection to annotate."; };
    img.onerror=function(){ cvPlaceholder(); };
    img.src=URL.createObjectURL(f);
    return;
  }
  if(f.type.indexOf("video/")===0){
    var v=document.createElement("video");
    v.muted=true;
    v.playsInline=true;
    v.src=URL.createObjectURL(f);
    v.onloadeddata=function(){ v.currentTime=0.05; };
    v.onseeked=function(){
      var off=document.createElement("canvas");
      off.width=v.videoWidth; off.height=v.videoHeight;
      var octx=off.getContext("2d"); octx.drawImage(v,0,0,off.width,off.height);
      var frame=new Image();
      frame.onload=function(){ cvImage=frame; drawImageFit(frame); document.getElementById("cvNote").textContent="Video frame captured. Run Detection to annotate."; };
      frame.onerror=function(){ cvPlaceholder(); };
      frame.src=off.toDataURL("image/png");
    };
    v.onerror=function(){ cvPlaceholder(); };
    return;
  }
  cvPlaceholder();
});

/* run detection */
document.getElementById("formCV").addEventListener("submit", function(e){
  e.preventDefault();
  var clsEls=document.querySelectorAll(".cv-cls:checked");
  var classes=[], i=0;
  for(i=0;i<clsEls.length;i++){ classes.push(clsEls[i].value); }
  renderLegendCV(classes);
  if(!cvImage || classes.length===0){ cvPlaceholder(); return; }

  var thr=parseInt(document.getElementById("cvThresh").value||"55",10);
  var maxd=parseInt(document.getElementById("cvMax").value||"12",10);

  var met=drawImageFit(cvImage);
  var boxes=synthCV(cvImage, classes, maxd, thr);
  drawBoxesCV(boxes, met);
  fillCVTable(boxes);
  updateCVCounts(boxes);

  cvAnnotatedURL=cvCanvas.toDataURL("image/png");
  document.getElementById("cvSave").disabled=false;
  document.getElementById("cvNote").textContent="Annotated "+boxes.length+" detection(s). All defects are highlighted on the image.";
});

/* save to history */
document.getElementById("cvSave").addEventListener("click", function(){
  if(!cvAnnotatedURL){ return; }
  var mediaEl=document.getElementById("cvMedia");
  var name=mediaEl.files && mediaEl.files[0] ? mediaEl.files[0].name : "uploaded_media";

  var rows=document.getElementById("cvTable").querySelectorAll("tr");
  var counts={}, i=0;
  for(i=0;i<rows.length;i++){
    var cls=rows[i].children[1].textContent;
    counts[cls]=(counts[cls]||0)+1;
  }
  var keys=Object.keys(counts);
  var summaryArr=[];
  for(i=0;i<keys.length;i++){
    var k=keys[i];
    summaryArr.push(k+": "+counts[k]);
  }
  var summary=summaryArr.join(", ");

  var tb=document.getElementById("tblCV");
  var tr=document.createElement("tr");

  var td1=document.createElement("td"); td1.textContent=new Date().toISOString().slice(0,10);
  var td2=document.createElement("td"); td2.textContent=name;
  var td3=document.createElement("td"); td3.textContent=summary || "—";
  var td4=document.createElement("td");
  var btn=document.createElement("button");
  btn.className="btn btn-sm btn-outline-primary";
  btn.textContent="View";
  btn.dataset.detail=encodeURIComponent(JSON.stringify({mode:"image",img:cvAnnotatedURL}));
  td4.appendChild(btn);

  tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4);
  tb.insertBefore(tr, tb.firstChild);

  openImageDetail("Annotated Result","All detected defects are highlighted with class tags and confidence.",cvAnnotatedURL);
});

/* ---------- 3.4.3 Digital Twin ---------- */
function randPts(n){
  var out=[], i=0;
  for(i=0;i<n;i++){ out.push({x:Math.random()*100,y:Math.random()*100,v:Math.random()*100}); }
  return out;
}
var twinPts=randPts(30);
var twinScatter=new Chart(
  document.getElementById("twinScatter").getContext("2d"),
  {
    type:"scatter",
    data:{
      datasets:[
        {
          label:"Hotspots",
          data:twinPts.map(function(p){return {x:p.x,y:p.y};}),
          pointRadius:twinPts.map(function(p){return 3+p.v/25;}),
          pointBackgroundColor:twinPts.map(function(p){return gradeColor(p.v);})
        }
      ]
    },
    options:{
      plugins:{legend:{display:false}},
      scales:{x:{title:{display:true,text:"X (m)"}},y:{title:{display:true,text:"Y (m)"}}}
    }
  }
);
addRow("tblTwin",["2025-09-19","Tank B07","30","Marine spray"],{mode:"scatter",points:twinPts});
document.getElementById("formTwin").addEventListener("submit",function(e){
  e.preventDefault();
  var n=parseInt(new FormData(e.target).get("pts")||"30",10);
  var pts=randPts(n);
  var ds=twinScatter.data.datasets[0];
  ds.data=pts.map(function(p){return {x:p.x,y:p.y};});
  ds.pointRadius=pts.map(function(p){return 3+p.v/25;});
  ds.pointBackgroundColor=pts.map(function(p){return gradeColor(p.v);});
  twinScatter.update();
  addRow("tblTwin",[new Date().toISOString().slice(0,10),"Asset",String(n),"Auto grid"],{mode:"scatter",points:pts});
});

/* ---------- 3.4.5 Remote Monitoring ---------- */
var remoteBar=new Chart(
  document.getElementById("remoteBar").getContext("2d"),
  {
    type:"bar",
    data:{labels:["Sensor A","Sensor B","Sensor C","Sensor D"],datasets:[{label:"Reading",data:[40,70,28,85]}]},
    options:{plugins:{legend:{position:"bottom"}},responsive:true}
  }
);
addRow("tblRemote",["08:15","PERIM-NE-02","A,B,C,D","85",""],{mode:"bar",labels:["A","B","C","D"],values:[40,70,28,85]});
var liveTimer=null;
document.getElementById("formRemote").addEventListener("submit",function(e){
  e.preventDefault();
  var sec=parseInt(new FormData(e.target).get("freq")||"5",10);
  if(liveTimer){ clearInterval(liveTimer); }
  liveTimer=setInterval(function(){
    var v1=30+Math.random()*25;
    var v2=50+Math.random()*35;
    var v3=18+Math.random()*25;
    var v4=60+Math.random()*35;
    remoteBar.data.datasets[0].data=[v1,v2,v3,v4];
    remoteBar.update();
  }, sec*1000);
  var now=new Date().toTimeString().slice(0,5);
  var copy=remoteBar.data.datasets[0].data.slice(0);
  addRow("tblRemote",[now,"PERIM-NE-02","A,B,C,D",String(copy[3]||0),""],{mode:"bar",labels:["A","B","C","D"],values:copy});
});

/* ---------- 3.4.4 Risk ---------- */
var riskAssets=["Pipeline A12","Tank B07","Vent D22","Crusher Frame","Shaft Beam 3"];
var riskVals=[82,58,23,35,70];
var riskBar=new Chart(
  document.getElementById("riskBar").getContext("2d"),
  {
    type:"bar",
    data:{labels:riskAssets,datasets:[{label:"Risk %",data:riskVals,backgroundColor:riskVals.map(gradeColor)}]},
    options:{indexAxis:"y",plugins:{legend:{display:false}},responsive:true,scales:{x:{min:0,max:100}}}
  }
);
addRow("tblRisk",["2025-09-17","Pipeline A12","82%","High"],{mode:"barh",labels:riskAssets.slice(0),values:riskVals.slice(0)});
document.getElementById("formRisk").addEventListener("submit",function(e){
  e.preventDefault();
  var fd=new FormData(e.target);
  var name=fd.get("name")||"New Asset";
  var age=parseInt(fd.get("age")||"10",10);
  var env=fd.get("env")||"C4";
  var add=5;
  if(env.indexOf("C4")>-1){ add=15; }
  if(env.indexOf("C5")>-1){ add=25; }
  var score=20+age*3+add;
  if(score>90){ score=90; }

  riskAssets.unshift(name);
  riskVals.unshift(score);
  if(riskAssets.length>8){ riskAssets.pop(); riskVals.pop(); }

  riskBar.data.labels=riskAssets.slice(0);
  riskBar.data.datasets[0].data=riskVals.slice(0);
  riskBar.data.datasets[0].backgroundColor=riskVals.map(gradeColor);
  riskBar.update();

  var pr=(score>=70?"High":(score>=40?"Medium":"Low"));
  addRow("tblRisk",[new Date().toISOString().slice(0,10),name,score+"%",pr],{mode:"barh",labels:riskAssets.slice(0),values:riskVals.slice(0)});
});

/* ---------- 3.4.6 Knowledge ---------- */
addRow("tblKnow",["Case #123 — Pipeline coating failure (2023)","82%","Recoat; CP tune"],{mode:"barh",labels:["Likelihood","Consequence"],values:[60,80]});
addRow("tblKnow",["Case #208 — Tank corrosion (2024)","58%","Seal roof; water draw"],{mode:"barh",labels:["Lik.","Consq."],values:[40,70]});
document.getElementById("formKnow").addEventListener("submit",function(e){
  e.preventDefault();
  var log=(new FormData(e.target).get("log")||"Case");
  var label=log.length>42? log.slice(0,42)+"…" : log;
  addRow("tblKnow",[label,"35%","Logged"],{mode:"barh",labels:["Lik.","Consq."],values:[20,35]});
});

/* ---------- CP ---------- */
var cpLine=new Chart(
  document.getElementById("cpLine").getContext("2d"),
  {
    type:"line",
    data:{labels:["T-4","T-3","T-2","T-1","Now"],datasets:[{label:"mV vs Cu/CuSO4",data:[-870,-860,-845,-835,-830],tension:0.3}]},
    options:{plugins:{legend:{position:"bottom"}},scales:{y:{title:{display:true,text:"mV (more negative = better)"}}}}
  }
);
document.getElementById("formCP").addEventListener("submit",function(e){
  e.preventDefault();
  var mV=parseInt(new FormData(e.target).get("mV")||"-830",10);
  var ds=cpLine.data.datasets[0].data.slice(1);
  ds.push(mV);
  cpLine.data.datasets[0].data=ds;
  cpLine.update();
});

/* ---------- RBI ---------- */
document.getElementById("formRBI").addEventListener("submit",function(e){
  e.preventDefault();
  var fd=new FormData(e.target);
  var cat=fd.get("cat")||"C4";
  var dur=fd.get("dur")||"High";
  var last=parseInt(fd.get("last")||"12",10);

  var base;
  if(cat==="C5/CX"){ base=6; }
  else if(cat==="C4"){ base=12; }
  else { base=18; }

  var mult=1.0;
  if(dur==="Very High"){ mult=1.3; }
  if(dur==="Medium"){ mult=0.7; }

  var next=Math.round(base*mult - Math.max(0,last-12)*0.3);
  if(next<3){ next=3; }

  document.getElementById("rbiPlan").textContent=
    "Next inspection in about "+next+" months (baseline "+base+" adjusted by durability "+dur+").";

  var coatText=(cat==="C5/CX")
    ? "Epoxy + Polyurethane, high DFT 240um+"
    : "Epoxy + Polyurethane, DFT 160–200um";
  document.getElementById("coatSuggest").textContent=
    "Suggested system: "+coatText+". Verify ISO-12944 compliance.";
});

/* ---------- modal router ---------- */
document.body.addEventListener("click",function(e){
  var b=e.target;
  if(!b || b.tagName!=="BUTTON" || b.textContent!=="View"){ return; }

  var payload=b.dataset.detail||"%7B%7D";
  var d={};
  try{ d=JSON.parse(decodeURIComponent(payload)); }catch(err){ d={}; }

  if(d.mode==="image" && d.img){
    openImageDetail("Annotated Result","All detected defects are highlighted with class tags and confidence.",d.img);
    return;
  }

  var cfg=null;
  var title="Details";
  var text="";

  if(d.mode==="line"){
    cfg={
      type:"line",
      data:{
        labels:d.labels||[],
        datasets:[
          {label:"Before",data:(d.before||[]),tension:0.3},
          {label:"After", data:(d.after||[]),tension:0.3}
        ]
      },
      options:{plugins:{legend:{position:"bottom"}}}
    };
    title="Forecast Comparison";
    text="Trend before vs AI-improved plan.";
  }else if(d.mode==="bar"){
    cfg={
      type:"bar",
      data:{labels:d.labels||[],datasets:[{label:"Count",data:(d.values||[])}]},
      options:{plugins:{legend:{position:"bottom"}}}
    };
    title="Detections Breakdown";
    text="Counts by defect class.";
  }else if(d.mode==="scatter"){
    var pts=d.points||[];
    cfg={
      type:"scatter",
      data:{
        datasets:[
          {
            label:"Hotspots",
            data:pts.map(function(p){return {x:p.x,y:p.y};}),
            pointRadius:pts.map(function(p){return 3+p.v/25;}),
            pointBackgroundColor:pts.map(function(p){return gradeColor(p.v);})
          }
        ]
      },
      options:{plugins:{legend:{display:false}}}
    };
    title="Hotspot Map";
    text="Larger/darker = higher intensity.";
  }else if(d.mode==="barh"){
    var vals=(d.values||[]);
    cfg={
      type:"bar",
      data:{labels:d.labels||[],datasets:[{label:"Score",data:vals,backgroundColor:vals.map(gradeColor)}]},
      options:{indexAxis:"y",plugins:{legend:{display:false}},scales:{x:{min:0,max:100}}}
    };
    title="Risk View";
    text="Use to prioritize inspections and CAPA.";
  }else{
    cfg={type:"bar",data:{labels:["A","B"],datasets:[{data:[1,2]}]}};
  }

  openChartDetail(title,text,cfg);
});
</script>


</body>
</html>
